---
title: "PE Ratio Indicator"
author: "Paul Adamson"
date: "December 3, 2015"
runtime: shiny
output: html_document
---

Price-to-Earnings Ratio of S&P 500 Over Time
--------------------------------------------
*WHAT IT IS*: The price of the index divided by the sum of the operating earnings per share of the companies in the index. 

*WHY IT MATTERS*: Earnings relative to the price of the S&P 500 offer a look at how investors 
view the prospects for corporate profits. A falling P/E could mean investors are losing 
confidence in the earnings outlook and the overall economy; a rising P/E means they're 
bullish. Data courtesy [McGraw Hill Financial](http://www.spindices.com/documents/additional-material/sp-500-eps-est.xlsx).

```{r PE, echo=FALSE,eval=FALSE}
require(xlsx)
#download file if older than 10 days
if (!file.exists("./sp-500-eps-est.xlsx") | 
    as.numeric(difftime(Sys.time(), file.mtime("./sp-500-eps-est.xlsx"), units = "days"))>10){
  download.file("http://www.spindices.com/documents/additional-material/sp-500-eps-est.xlsx", 
                destfile="./sp-500-eps-est.xlsx", 
                method="curl")
}
sp500pe.est<-read.xlsx("./sp-500-eps-est.xlsx",1, startRow = 127, endRow = 132, colIndex=c(1,6,7),
                       header=FALSE, colClasses = c("character","numeric","numeric"),
                       stringsAsFactors=FALSE)
sp500pe.act<-read.xlsx("./sp-500-eps-est.xlsx",1, startRow = 135, endRow = 240, colIndex=c(1,6,7),
                       header=FALSE, colClasses = c("character","numeric","numeric"),
                       stringsAsFactors=FALSE)
sp500pe.est$X1[6]<-unlist(strsplit(sp500pe.est$X1[6], split=' ', fixed=TRUE))[1]
sp500pe<-rbind(sp500pe.est,sp500pe.act)
sp500pe$X1<-as.Date(sp500pe$X1,format="%m/%d/%Y")
#check for NAs in date column and replace through interpolation
for (i in 2:(length(sp500pe$X1)-1)) {
  if (is.na(sp500pe$X1[i])) {
    sp500pe$X1[i] = sp500pe$X1[i-1] + floor((sp500pe$X1[i+1]-sp500pe$X1[i-1])/2)
  }
}
# plot(X6~X1,sp500pe,type='l',main="S&P 500 P/E Ratio\nOperating Earnings",xlab='',ylab='')
# plot(X7~X1,sp500pe,type='l',main="S&P 500 P/E Ratio\nAs Reported",xlab='',ylab='',
#      ylim=c(10,30))
sp500pe.op<-xts(sp500pe$X6,order.by=sp500pe$X1)
sp500pe.rep<-xts(sp500pe$X7,order.by=sp500pe$X1)

maxpeDate <-  range(index(sp500pe.op))[2]
minpeDate <-  range(index(sp500pe.op))[1]
peDatesMin <- seq(maxpeDate, length = 2, by = "-2 years")[2]

fluidPage(
  fluidRow(
    column(6,
           checkboxInput("peLog", "Y-axis on log scale", 
                         value = FALSE)
    )
  ),
  fluidRow(
    column(12,
           sliderInput("peDates",
                       "Date range",
                       min=minpeDate,
                       max=maxpeDate,
                       value=c(peDatesMin,maxpeDate),
                       width='1200px')
    )
  )
)

renderPlot({
  chartSeries(sp500pe.op, 
              subset=paste(input$peDates, collapse = "::"),
              theme=thm,
              log.scale = input$peLog,
              name = "S&P 500 P/E-Op Earnings")
})
renderPlot({
   chartSeries(sp500pe.rep, 
              subset=paste(input$peDates, collapse = "::"),
              theme=thm,
              log.scale = input$peLog,
              name = "S&P 500 P/E-As Reported")
})
```
